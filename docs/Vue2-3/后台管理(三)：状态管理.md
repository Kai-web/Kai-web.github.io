---
title: çŠ¶æ€ç®¡ç†ä¸Piniaé›†æˆ
---

# Vue3åå°ç®¡ç†ç³»ç»Ÿï¼ˆä¸‰ï¼‰ï¼šçŠ¶æ€ç®¡ç†ä¸Piniaé›†æˆ

## ä¸€ã€ä»Vuexåˆ°Piniaçš„è½¬å˜

### 1.1 ä¸ºä»€ä¹ˆé€‰æ‹©Piniaï¼Ÿ

åœ¨Vue2ä¸­ï¼ŒVuexæ˜¯å®˜æ–¹æ¨èçš„çŠ¶æ€ç®¡ç†åº“ã€‚ä½†éšç€Vue3çš„å‘å¸ƒï¼ŒPiniaä½œä¸ºä¸‹ä¸€ä»£çš„çŠ¶æ€ç®¡ç†å·¥å…·å‡ºç°äº†ï¼Œå¹¶ä¸”å·²ç»æˆä¸ºäº†Vueå®˜æ–¹æ¨èçš„çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚Piniaç›¸æ¯”Vuexæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **æ›´ç®€æ´çš„API**ï¼šæ²¡æœ‰mutationsï¼Œåªæœ‰stateã€getterså’Œactions
- **å®Œæ•´çš„TypeScriptæ”¯æŒ**ï¼šè‡ªåŠ¨äº«å—åˆ°ç±»å‹æ¨æ–­
- **å»é™¤å‘½åç©ºé—´**ï¼šæ›´åŠ æ‰å¹³åŒ–çš„è®¾è®¡ï¼Œå‡å°‘æ¨¡å—åµŒå¥—
- **æ›´å¥½çš„ä»£ç æ‹†åˆ†**ï¼šæ¯ä¸ªstoreå¯ä»¥ç‹¬ç«‹å¯¼å…¥å’Œä½¿ç”¨
- **æè½»çš„ä½“ç§¯**ï¼šçº¦1KBçš„å¤§å°
- **æ”¯æŒå¤šä¸ªStoreå®ä¾‹**ï¼šå¯ä»¥åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„çŠ¶æ€ç®¡ç†å®ä¾‹

### 1.2 åŸºæœ¬æ¦‚å¿µå¯¹æ¯”

| Vuex | Pinia | è¯´æ˜ |
|------|-------|------|
| state | state | å­˜å‚¨çŠ¶æ€ |
| getters | getters | è®¡ç®—å±æ€§ |
| mutations | - | Piniaä¸­ç›´æ¥åœ¨actionsä¸­ä¿®æ”¹state |
| actions | actions | å¼‚æ­¥æ“ä½œ |
| modules | storeæ–‡ä»¶ | æ¯ä¸ªstoreæ–‡ä»¶ç›¸å½“äºä¸€ä¸ªmodule |

## äºŒã€Piniaçš„åŸºæœ¬é…ç½®

```javascript
// src/main.js
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import ElementPlus from 'element-plus'
import * as ElementPlusIconsVue from '@element-plus/icons-vue'
import autofit from 'autofit.js'
import 'element-plus/dist/index.css'
import './styles/index.scss'
import App from './App.vue'
import router from './router'
import zhCn from 'element-plus/dist/locale/zh-cn.mjs'
import { setupPermissionDirective } from './directives/permission'
import { useLayoutStore } from '@/stores/layout'

// åº”ç”¨å®ä¾‹
const app = createApp(App)

// Pinia å®ä¾‹
const pinia = createPinia()

// å®‰è£… Pinia
app.use(pinia)

// å…¶ä»–é…ç½®
// ...

// ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œæ›´æ–°scaleå€¼
window.addEventListener('resize', () => {
	const layoutStore = useLayoutStore()
	layoutStore.setScale(autofit.scale)
})

// é¡µé¢æŒ‚è½½
app.mount('#app')
```

## ä¸‰ã€Storeæ¨¡å—è®¾è®¡

åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæˆ‘è®¾è®¡äº†å‡ ä¸ªæ ¸å¿ƒçš„Storeæ¨¡å—ï¼š

1. **Auth Store**: ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†
2. **Layout Store**: å¸ƒå±€è®¾ç½®å’Œè§†å›¾è°ƒæ•´
3. **Loading Store**: å…¨å±€åŠ è½½çŠ¶æ€ç®¡ç†

### 3.1 Auth Store - ç”¨æˆ·è®¤è¯ä¸æƒé™

```javascript
/**
 * @description ç”¨æˆ·çŠ¶æ€ç®¡ç†
 * @Author Wangkaibing
 * @Date 2025-04-18
 *
 * Usageï¼š
 * import { useAuthStore } from '@/stores/auth'
 *
 * // åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
 * const authStore = useAuthStore()
 *
 * // è®¿é—®çŠ¶æ€
 * console.log(authStore.state.userInfo)  // ç”¨æˆ·ä¿¡æ¯
 * console.log(authStore.state.roles)     // ç”¨æˆ·è§’è‰²åˆ—è¡¨
 * console.log(authStore.isAuthenticated) // æ˜¯å¦å·²ç™»å½•
 * console.log(authStore.hasRoles)        // æ˜¯å¦æœ‰è§’è‰²ä¿¡æ¯
 *
 * // ä¿®æ”¹çŠ¶æ€
 * authStore.setUserInfo({                            // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
 *   fullName: 'å¼ ä¸‰',
 *   mobile: '13800138000',
 *   roles: [{ authority: 'ROLE_ADMIN' }]
 * })
 *
 * // æƒé™æ£€æŸ¥
 * if (authStore.hasPermission('SOME_PERMISSION')) {
 *   // æœ‰æƒé™æ—¶çš„é€»è¾‘
 * }
 *
 * // æ¸…é™¤çŠ¶æ€
 * authStore.reset()  // æ¸…é™¤æ‰€æœ‰çŠ¶æ€ï¼ˆé€€å‡ºæ—¶ä½¿ç”¨ï¼‰
 */
import { defineStore } from 'pinia' // PiniaçŠ¶æ€ç®¡ç†åº“æ ¸å¿ƒAPI
import { ref, computed } from 'vue' // Vue3å“åº”å¼API
import { TokenService } from '@/utils/token' // è‡ªå®šä¹‰Tokenç®¡ç†æœåŠ¡
export const useAuthStore = defineStore('auth', () => {
	// ä½¿ç”¨refåˆ›å»ºå“åº”å¼çŠ¶æ€å¯¹è±¡
	const state = ref({
		userInfo: null, // ç”¨æˆ·åŸºç¡€ä¿¡æ¯
		roles: [], // ç”¨æˆ·è§’è‰²åˆ—è¡¨
		permissions: [], // ç”¨æˆ·æƒé™åˆ—è¡¨
	})
	// ä½¿ç”¨å•ä¸€stateå¯¹è±¡è€Œéå¤šä¸ªref
	// 1. ä¾¿äºç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç”¨æˆ·ç›¸å…³çŠ¶æ€
	// 2. è°ƒè¯•å·¥å…·ä¸­å¯ä»¥æ¸…æ™°çœ‹åˆ°å®Œæ•´çŠ¶æ€ç»“æ„
	// 3. æ–¹ä¾¿ä¸€æ¬¡æ€§é‡ç½®æ‰€æœ‰çŠ¶æ€

	// æ˜¯å¦å·²ç™»å½• - åŸºäºtokenåˆ¤æ–­çš„è®¡ç®—å±æ€§
	const isAuthenticated = computed(() => TokenService.isAuthenticated())
	// ä½¿ç”¨è®¡ç®—å±æ€§ä»£æ›¿çŠ¶æ€å˜é‡
	// 1. ç™»å½•çŠ¶æ€ä¾èµ–äºtokenæ˜¯å¦å­˜åœ¨ï¼Œé€šè¿‡è®¡ç®—å±æ€§å¯ä¿æŒåŒæ­¥
	// 2. é¿å…çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜ï¼Œè®¡ç®—å±æ€§æ€»æ˜¯è¿”å›æœ€æ–°ç»“æœ
	// 3. æ— éœ€æ‰‹åŠ¨ç»´æŠ¤ç™»å½•çŠ¶æ€ï¼Œå‡å°‘å‡ºé”™å¯èƒ½

	// æ˜¯å¦æœ‰è§’è‰²ä¿¡æ¯ - ç”¨äºåˆ¤æ–­æ˜¯å¦å·²åŠ è½½ç”¨æˆ·ä¿¡æ¯
	const hasRoles = computed(() => state.value.roles && state.value.roles.length > 0)
	// è®¾ç½®ç”¨æˆ·ä¿¡æ¯å¹¶æå–å…³é”®æ•°æ®
	const setUserInfo = (userInfo) => {
		if (!userInfo) return // é¿å…è®¾ç½®ç©ºå€¼
		state.value.userInfo = userInfo
		// æå–è§’è‰²ä¿¡æ¯ - å°†åµŒå¥—ç»“æ„è½¬æ¢ä¸ºæ‰å¹³æ•°ç»„
		if (userInfo.roles && Array.isArray(userInfo.roles)) {
			state.value.roles = userInfo.roles.map((item) => item.authority)
		}
		// æå–æƒé™ä¿¡æ¯
		state.value.permissions = userInfo.permissions || []
	}
	// æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
	const clearUserInfo = () => {
		state.value.userInfo = {}
		state.value.roles = []
		state.value.permissions = []
	}

	// é‡ç½®æ‰€æœ‰çŠ¶æ€ - ç”¨äºé€€å‡ºç™»å½•
	const reset = () => {
		TokenService.clearTokens() // å…ˆæ¸…é™¤å­˜å‚¨çš„token
		clearUserInfo() // å†æ¸…é™¤å†…å­˜ä¸­çš„çŠ¶æ€
	}

	// æƒé™æ£€æŸ¥æ–¹æ³•
	const hasPermission = (permission) => {
		if (!state.value.permissions || state.value.permissions.length === 0) {
			return false // æ²¡æœ‰æƒé™åˆ—è¡¨æ—¶ç›´æ¥è¿”å›false
		}
		if (Array.isArray(permission)) {
			// å¦‚æœä¼ å…¥æƒé™æ•°ç»„ï¼Œåªè¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæƒé™å³å¯
			return permission.some((p) => state.value.permissions.includes(p))
			// ä½¿ç”¨Array.someå®ç°"æˆ–"é€»è¾‘
			// çµæ´»æ”¯æŒå¤šç§æƒé™æ£€æŸ¥åœºæ™¯
		}
		// æ£€æŸ¥å•ä¸ªæƒé™
		return state.value.permissions.includes(permission)
	}

	return {
		state, // çŠ¶æ€å¯¹è±¡
		isAuthenticated, // ç™»å½•çŠ¶æ€
		hasRoles, // æ˜¯å¦æœ‰è§’è‰²ä¿¡æ¯
		setUserInfo, // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
		clearUserInfo, // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
		hasPermission, // æƒé™æ£€æŸ¥
		reset, // é‡ç½®çŠ¶æ€
	}
})
```

è¿™ä¸ªAuth Storeå¤„ç†äº†ï¼š

- ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†
- ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²æƒé™çš„å­˜å‚¨
- æƒé™æ£€æŸ¥é€»è¾‘
- tokenç®¡ç†ï¼ˆé€šè¿‡TokenServiceï¼‰

### 3.2 Loading Store - å…¨å±€åŠ è½½çŠ¶æ€

```javascript
/**
 * @description loadingçŠ¶æ€
 * @Author Wangkaibing
 * @Date 2025-04-18
 * Usageï¼š
 * import { storeToRefs } from 'pinia'
 * import { useLoadingStore } from '@/stores/loading'
 *
 * // åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
 * const { loading } = storeToRefs(useLoadingStore())
 *
 * // åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨
 * <div v-loading="loading">...</div>
 *
 * // æ‰‹åŠ¨æ§åˆ¶loading
 * const loadingStore = useLoadingStore()
 * loadingStore.showLoading()  // æ˜¾ç¤ºloading
 * loadingStore.hideLoading()  // éšè—loading
 *
 * // åœ¨è¯·æ±‚ä¸­è‡ªåŠ¨ï¼ˆå·²åœ¨request.jsä¸­é›†æˆï¼‰
 * useGet('/api/data')  // è‡ªåŠ¨æ˜¾ç¤ºloading
 * useGet('/api/data', {}, { loading: false })  // ç¦ç”¨loading
 */

import { defineStore } from 'pinia' // PiniaçŠ¶æ€ç®¡ç†åº“
import { ref } from 'vue' // Vue3å“åº”å¼API

export const useLoadingStore = defineStore('loading', () => {
	// ä½¿ç”¨refåˆ›å»ºå“åº”å¼çŠ¶æ€ï¼Œé»˜è®¤ä¸ºfalse(ä¸åŠ è½½)
	const loading = ref(false)
	// ç®€å•çŠ¶æ€ç®¡ç†
	// 1. å¯¹äºç®€å•çŠ¶æ€ï¼Œç›´æ¥ä½¿ç”¨refè€Œä¸æ˜¯å¤æ‚å¯¹è±¡
	// 2. å¸ƒå°”å€¼è¶³ä»¥è¡¨ç¤ºloadingçŠ¶æ€ï¼Œæ— éœ€é¢å¤–å­—æ®µ

	// æ˜¾ç¤ºloadingçŠ¶æ€
	const showLoading = () => {
		loading.value = true
	}

	// éšè—loadingçŠ¶æ€
	const hideLoading = () => {
		loading.value = false
	}

	return {
		loading, // å¯¼å‡ºçŠ¶æ€ï¼Œä¾›ç»„ä»¶ä½¿ç”¨
		showLoading, // æ˜¾ç¤ºloadingçš„æ–¹æ³•
		hideLoading, // éšè—loadingçš„æ–¹æ³•
	}
})
```

Loading Storeä¸»è¦ç”¨äºï¼š

- å…¨å±€loadingçŠ¶æ€æ§åˆ¶
- ä¸è¯·æ±‚åº“é›†æˆï¼Œè‡ªåŠ¨å¤„ç†åŠ è½½çŠ¶æ€
- å¯ä»¥è¢«ä»»ä½•ç»„ä»¶è®¢é˜…ï¼Œå®ç°ç»Ÿä¸€çš„åŠ è½½æç¤º

### 3.3 Layout Store - å¸ƒå±€è®¾ç½®

```javascript
/**
 * @description è®°å½•é¡µé¢çš„ç¼©æ”¾æ¯”ä¾‹
 * @Author Wangkaibing
 * @Date 2025-04-15
 * Usageï¼š
 * import { useLayoutStore } from '@/stores/layout'
 * æ ¹æ®scaleè‡ªåŠ¨è®¡ç®—æ˜¯å¦æ”¶èµ·
 * const isCollapse = computed(() => layoutStore.scale < 0.75)
 */

import { defineStore } from 'pinia' // PiniaçŠ¶æ€ç®¡ç†åº“
import { ref } from 'vue' // Vue3å“åº”å¼API

export const useLayoutStore = defineStore('layout', () => {
	// é¡µé¢ç¼©æ”¾æ¯”ä¾‹ - é»˜è®¤ä¸º1(åŸå§‹å¤§å°)
	const scale = ref(1)
	// ä½¿ç”¨refå­˜å‚¨ç®€å•æ•°å€¼
	// 1. å¯¹äºç®€å•æ•°æ®ç±»å‹ï¼Œç›´æ¥ä½¿ç”¨refè€Œéreactive
	// 2. ç¼©æ”¾æ¯”ä¾‹ä½œä¸ºå…¨å±€å…±äº«çŠ¶æ€ï¼Œä¾¿äºä¸åŒç»„ä»¶è®¿é—®

	// è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
	const setScale = (value) => {
		scale.value = value
		// æä¾›setteræ–¹æ³•
		// 1. è™½ç„¶å¯ä»¥ç›´æ¥ä¿®æ”¹scale.valueï¼Œä½†å°è£…æˆæ–¹æ³•æ›´è§„èŒƒ
	}

	return {
		scale, // å½“å‰ç¼©æ”¾æ¯”ä¾‹
		setScale, // è®¾ç½®ç¼©æ”¾æ¯”ä¾‹çš„æ–¹æ³•
	}
})
```

Layout Storeè´Ÿè´£ç®¡ç†åº”ç”¨çš„å¸ƒå±€çŠ¶æ€ï¼š

- é¡µé¢ç¼©æ”¾æ¯”ä¾‹ç®¡ç†ï¼šæ ¹æ®ä¸åŒå±å¹•å°ºå¯¸è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
- æ§åˆ¶ä¾§è¾¹æ çš„å±•å¼€å’Œæ”¶èµ·ï¼šé€šè¿‡è®¡ç®—å±æ€§ç»“åˆç¼©æ”¾æ¯”ä¾‹è‡ªåŠ¨æ§åˆ¶
- é€‚åº”ä¸åŒè®¾å¤‡ï¼šç¡®ä¿åº”ç”¨åœ¨å„ç§å°ºå¯¸å±å¹•ä¸Šéƒ½èƒ½è‰¯å¥½å±•ç¤º

## å››ã€ç»„åˆå¼APIä¸Piniaçš„ç»“åˆ

### 4.1 åœ¨ç»„åˆå¼APIä¸­ä½¿ç”¨Store

```vue
<script setup>
import { useAuthStore } from '@/stores/auth' // å¼•å…¥Auth Store
import { useLoadingStore } from '@/stores/loading' // å¼•å…¥Loading Store
import { storeToRefs } from 'pinia' // å¼•å…¥storeToRefsè¾…åŠ©å‡½æ•°ï¼Œç”¨äºä¿æŒå“åº”å¼

// è·å–Auth Storeå®ä¾‹
const authStore = useAuthStore()

// ä»Loading Storeä¸­è§£æ„loadingçŠ¶æ€ï¼Œå¹¶ä¿æŒå“åº”å¼
const { loading } = storeToRefs(useLoadingStore())
// ä½¿ç”¨storeToRefsè¿›è¡Œè§£æ„
// 1. ç›´æ¥è§£æ„storeä¼šå¤±å»å“åº”æ€§ï¼ŒstoreToRefså¯ä»¥ä¿æŒå“åº”å¼
// 2. åªæå–éœ€è¦çš„çŠ¶æ€ï¼Œå‡å°‘ä¸å¿…è¦çš„ä¾èµ–
// 3. è§£æ„åå¯ä»¥ç›´æ¥åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨ï¼Œæ— éœ€å‰ç¼€

// ä½¿ç”¨Auth Storeçš„æ–¹æ³•
const handleLogout = () => {
  authStore.reset() // è°ƒç”¨storeæ–¹æ³•é‡ç½®çŠ¶æ€
  router.push('/login') // è·³è½¬åˆ°ç™»å½•é¡µ
  // å¤ç”¨storeæä¾›çš„æ–¹æ³•
  // å°è£…å¸¸ç”¨æ“ä½œï¼Œä»£ç æ›´ç®€æ´ï¼Œé€»è¾‘æ›´æ¸…æ™°
}

// æƒé™æ£€æŸ¥ï¼Œä½¿ç”¨è®¡ç®—å±æ€§ç»“åˆstoreæ–¹æ³•
const canDelete = computed(() => {
  return authStore.hasPermission('user:delete')
  // åŸºäºstoreçŠ¶æ€çš„è®¡ç®—å±æ€§
  // 1. è‡ªåŠ¨è·Ÿè¸ªä¾èµ–å¹¶åœ¨æƒé™å˜åŒ–æ—¶é‡æ–°è®¡ç®—
  // 2. ç»“åˆVue3çš„å“åº”å¼ç³»ç»Ÿï¼Œä¼˜é›…å¤„ç†æƒé™åˆ¤æ–­
  // 3. å¯ç”¨äºæ§åˆ¶UIå…ƒç´ çš„æ˜¾ç¤º/éšè—
})
</script>
```

ä½¿ç”¨`storeToRefs`å¯ä»¥åœ¨è§£æ„storeæ—¶ä¿æŒå“åº”å¼

### 4.2 åˆ›å»ºè‡ªå®šä¹‰ç»„åˆå¼å‡½æ•°

```javascript
// src/composables/useUser.js
/**
 * @description ç”¨æˆ·ç›¸å…³ä¸šåŠ¡é€»è¾‘hook
 * @Author Wangkaibing
 * @Date 2025-04-18
 *
 * Usageï¼š
 * import { useUser } from '@/composables/useUser'
 *
 * // åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
 * const { getUserInfo, userInfo, hasPermission } = useUser()
 *
 * // è·å–ç”¨æˆ·ä¿¡æ¯
 * await getUserInfo()
 *
 * // è®¿é—®ç”¨æˆ·ä¿¡æ¯
 * console.log(userInfo.value.fullName)
 * console.log(userInfo.value.mobile)
 * console.log(userInfo.value.roles)
 *
 * // æ£€æŸ¥æƒé™
 * if (hasPermission('SOME_PERMISSION')) {
 *   // æœ‰æƒé™æ—¶çš„é€»è¾‘
 * }
 */

import { useGet } from '@/api/request'
import { useAuthStore } from '@/stores/auth'

export function useUser() {
	const authStore = useAuthStore()

	/**
	 * è·å–ç”¨æˆ·ä¿¡æ¯
	 * @returns {Promise<Object>} ç”¨æˆ·ä¿¡æ¯
	 */
	const getUserInfo = async () => {
		try {
			const res = await useGet('/api/xxxxxxx')
			if (!res?.success) {
				throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥')
			}
			authStore.setUserInfo(res.data)
			return res.data
		} catch (error) {
			console.log('ğŸš€ ~ [error]', error)
			throw error
		}
	}

	return {
		getUserInfo,
		// å¯¼å‡ºstoreä¸­çš„ä¸€äº›å¸¸ç”¨æ–¹æ³•ï¼Œæ–¹ä¾¿ä½¿ç”¨
		hasPermission: authStore.hasPermission,
		isAuthenticated: authStore.isAuthenticated,
		hasRoles: authStore.hasRoles,
		userInfo: authStore.state.userInfo,
	}
}
```

## äº”ã€æŒä¹…åŒ–ä¸çŠ¶æ€æ¢å¤

### 5.1 TokenæŒä¹…åŒ–

```javascript
// src/utils/token.js
/**
 * @description TokenæœåŠ¡ç±»
 * @Author Wangkaibing
 * @Date 2025-05-06
 *
 * Usage:
 * import { TokenService } from '@/utils/token'
 *
 * // è·å–token
 * TokenService.getToken()
 *
 * // è®¾ç½®token
 * TokenService.setTokens(accessToken, refreshToken, expiresIn)
 *
 * // æ¸…é™¤token
 * TokenService.clearTokens()
 */

import { setCookie, getCookie, removeCookie } from '@/utils/cookie'

export class TokenService {
	static TOKEN_KEY = 'xxxx'
	static REFRESH_TOKEN_KEY = 'xxxxx'

	static getToken() {
		return getCookie(this.TOKEN_KEY)
	}

	static getRefreshToken() {
		return getCookie(this.REFRESH_TOKEN_KEY)
	}

	static setTokens(accessToken, refreshToken = '', expiresIn = 7200) {
		if (accessToken) {
			setCookie(this.TOKEN_KEY, accessToken, expiresIn)
		}
		if (refreshToken) {
			setCookie(this.REFRESH_TOKEN_KEY, refreshToken, expiresIn)
		}
	}

	static clearTokens() {
		removeCookie(this.TOKEN_KEY)
		removeCookie(this.REFRESH_TOKEN_KEY)
	}

	static isAuthenticated() {
		return !(!this.getToken() && !this.getRefreshToken())
	}
}
```

### 5.2 ç”¨æˆ·çŠ¶æ€æ¢å¤

åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªåŠ¨æ¢å¤ç”¨æˆ·çŠ¶æ€ï¼š

```javascript
// åœ¨è·¯ç”±å®ˆå«ä¸­æ¢å¤ç”¨æˆ·çŠ¶æ€
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore() // è·å–è®¤è¯çŠ¶æ€ç®¡ç†
  const { getUserInfo } = useUser() // è·å–ç”¨æˆ·ä¿¡æ¯ç›¸å…³æ–¹æ³•

  // å¦‚æœå·²ç™»å½•ä½†æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå°è¯•è·å–
  if (authStore.isAuthenticated && !authStore.hasRoles) {
    try {
      await getUserInfo() // å¼‚æ­¥è·å–å¹¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      // æŒ‰éœ€åŠ è½½ç”¨æˆ·ä¿¡æ¯
      // 1. åªåœ¨å¿…è¦æ—¶è¯·æ±‚ç”¨æˆ·ä¿¡æ¯ï¼Œå‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
      // 2. ä½¿ç”¨è®¡ç®—å±æ€§hasRolesåˆ¤æ–­æ˜¯å¦éœ€è¦åŠ è½½ï¼Œé¿å…é‡å¤è¯·æ±‚
    } catch (error) {
      // è·å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯tokenè¿‡æœŸ
      authStore.reset() // é‡ç½®è®¤è¯çŠ¶æ€
      next('/login') // è·³è½¬åˆ°ç™»å½•é¡µ
      return
      // é”™è¯¯å¤„ç†ä¸æ¢å¤
      // 1. æ•è·å¹¶å¤„ç†å¯èƒ½çš„é”™è¯¯ï¼Œé˜²æ­¢åº”ç”¨å´©æºƒ
      // 2. é‡åˆ°è®¤è¯é”™è¯¯æ—¶æ¸…é™¤æ— æ•ˆçŠ¶æ€å¹¶é‡å®šå‘
      // 3. returnæå‰ç»“æŸå‡½æ•°ï¼Œé¿å…æ‰§è¡Œåé¢çš„next()
    }
  }

  next() // ç»§ç»­å¯¼èˆªæµç¨‹
  // å¼‚æ­¥è·¯ç”±å®ˆå«
  // 1. è·¯ç”±å®ˆå«æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œç­‰å¾…getUserInfoå®Œæˆ
  // 2. åœ¨åˆé€‚çš„æ¡ä»¶ä¸‹è°ƒç”¨next()ç»§ç»­å¯¼èˆª
  // 3. ç»“åˆPiniaå’Œç»„åˆå¼APIå®ç°ä¼˜é›…çš„çŠ¶æ€æ¢å¤
})
```

## å…­ã€ä¸ç½‘ç»œè¯·æ±‚çš„é›†æˆ

### 6.1 è‡ªåŠ¨å¤„ç†å…¨å±€loading

```javascript
// src/api/request.js
/**
 * @description APIè¯·æ±‚å°è£…
 * @Author Wangkaibing
 * @Date 2025-04-22
 *
 * Usageï¼š
 * import { useGet, usePost, usePut } from '@/api/request'
 *
 * // GETè¯·æ±‚
 * const getData = () => useGet('/api/data', {
 *   page: 1,
 *   size: 10
 * }, {
 *   loading: false,        // æ˜¯å¦æ˜¾ç¤ºloading
 *   meta: { noAuth: true } // æ˜¯å¦éœ€è¦token
 * })
 *
 * // POSTè¯·æ±‚ (éœ€è¦tokenè®¤è¯)
 * const createData = () => usePost('/api/data', {
 *   name: 'ç¤ºä¾‹',
 *   type: 1
 * })
 *
 * // PUTè¯·æ±‚ (éœ€è¦tokenè®¤è¯)
 * const updateData = () => usePut('/api/data/1', {
 *   name: 'æ›´æ–°'
 * })
 *
 * // ç™»å½•è¯·æ±‚ (ä¸éœ€è¦tokenè®¤è¯)
 * const login = () => usePost('/api/login', loginData, {
 *   meta: { noAuth: true }
 * })
 *
 * // åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
 * const { loading, data, error } = getData()
 */

import { createAlova } from 'alova'
import VueHook from 'alova/vue'
import adapterFetch from 'alova/fetch'
import { baseConfig, whiteList } from './config'
import { showLoading, hideLoading } from './loading'
import { showError } from './error'
import { onAuthRequired, onResponseRefreshToken } from './auth'

// åˆ›å»º alova å®ä¾‹
const alovaInstance = createAlova({
	...baseConfig,
	statesHook: VueHook,
	requestAdapter: adapterFetch(),

	// è¯·æ±‚æ‹¦æˆª
	beforeRequest: (method) => {
		// æ£€æŸ¥æ˜¯å¦æ˜¯ç™½åå•æ¥å£
		const url = method.url.replace(baseConfig.baseURL, '')
		if (whiteList.includes(url)) {
			method.meta = { ...method.meta, noAuth: true }
		}

		// è°ƒç”¨è®¤è¯æ‹¦æˆªå™¨
		onAuthRequired((method) => {
			// å¦‚æœé…ç½®äº† loading: false æˆ– æ˜¯æ¥å£ç¼“å­˜è¯·æ±‚ï¼Œåˆ™ä¸æ˜¾ç¤º loading
			if (method.config.loading !== false && !method.config?.cacheKey) {
				showLoading()
			}
		})(method)
	},

	// å“åº”æ‹¦æˆª
	responded: onResponseRefreshToken({
		onSuccess: async (response) => {
			try {
				// æ£€æŸ¥å“åº”å†…å®¹ç±»å‹å’Œé•¿åº¦
				const contentType = response.headers.get('content-type');
				const contentLength = response.headers.get('content-length');
				let responseData = null;
				// åªæœ‰å½“å†…å®¹ç±»å‹åŒ…å«jsonä¸”å†…å®¹é•¿åº¦ä¸ä¸º0æ—¶æ‰å°è¯•è§£æJSON
				if (contentType && contentType.includes('application/json') && (!contentLength || parseInt(contentLength) > 0)) {
					// ä½¿ç”¨clone()æ¥å…‹éš†responseï¼Œé¿å…"body stream already read"é”™è¯¯
					responseData = await response.clone().json();
				}
				// HTTPé”™è¯¯å’Œä¸šåŠ¡é”™è¯¯
				if (!response.ok || (responseData && responseData.success === false)) {
					const urlPath = new URL(response.url).pathname
					const error = {
						status: response.status,
						data: responseData,
						message: responseData?.message || (!response.ok ? 'è¯·æ±‚å¤±è´¥' : 'æ“ä½œå¤±è´¥'),
						url: urlPath,
					}
					showError(error)
					return Promise.reject(error)
				}
				return responseData
			} catch (err) {
				console.log('ğŸš€ ~ [err]', err)
				showError({ status: response.status })
				return Promise.reject(err)
			}
		},
		onError: (error) => {
			console.log('ğŸš€ ~ [error]', error)
			// å¦‚æœæ˜¯401é”™è¯¯ï¼Œè®©authæ‹¦æˆªå™¨å¤„ç†
			if (error.status === 401) {
				return Promise.reject(error)
			}
			let urlPath = ''
			try {
				if (error.request?.url) {
					urlPath = new URL(error.request.url).pathname
				}
			} catch (e) {}
			const errorObj = {
				status: error.status || 500,
				message: error.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
				url: urlPath,
			}
			showError(errorObj)
			return Promise.reject(errorObj)
		},
		onComplete: () => {
			hideLoading()
		},
	}),
})

// å¯¼å‡ºè¯·æ±‚æ–¹æ³•
export const useGet = (url, params = {}, config = {}) => {
	return alovaInstance.Get(url, {
		params,
		...config,
		headers: {
			...config.headers,
		},
		meta: {
			...config.meta,
		},
	})
}

export const usePost = (url, data = {}, config = {}) => {
	return alovaInstance.Post(url, data, {
		...config,
		headers: {
			...config.headers,
		},
		meta: {
			...config.meta,
		},
	})
}
```
### 6.2 é”™è¯¯å¤„ç†ä¸è‡ªåŠ¨ç™»å‡º

```javascript
// src/api/auth.js
/**
 * @description Tokenè®¤è¯æ‹¦æˆªå™¨
 * @Author Wangkaibing
 * @Date 2025-04-22
 */

import { createClientTokenAuthentication } from 'alova/client'
import { ElNotification } from 'element-plus'
import { TokenService } from '@/utils/token'
import { createAlova } from 'alova'
import VueHook from 'alova/vue'
import adapterFetch from 'alova/fetch'
import { baseConfig } from '@/api/config'

// åˆ›å»ºä¸“ç”¨çš„alovaå®ä¾‹ç”¨äºåˆ·æ–°token
const alovaInstance = createAlova({
	baseURL: baseConfig.baseURL,
	statesHook: VueHook,
	requestAdapter: adapterFetch(),
	headers: {
		'Content-Type': 'application/json',
		'Cache-Control': 'no-cache',
		'Pragma': 'no-cache',
	},
})

// åˆ·æ–°tokenæ–¹æ³•
export const refreshTokenRequest = () => {
	const refreshToken = TokenService.getRefreshToken()
	if (!refreshToken) {
		throw new Error('æœªæ‰¾åˆ°token')
	}

	const method = alovaInstance.Post('/api/oauth/access_token', {
		grant_type: 'refresh_token',
		refresh_token: refreshToken,
	})
	method.meta = {
		noAuth: true, // ä¸éœ€è¦tokenéªŒè¯çš„è¯·æ±‚
	}
	return method
}

// åˆ›å»ºå®¢æˆ·ç«¯tokenè®¤è¯æ‹¦æˆªå™¨
export const { onAuthRequired, onResponseRefreshToken } = createClientTokenAuthentication({
	assignToken: (method) => {
		const token = TokenService.getToken()
		if (token) {
			method.config.headers.Authorization = token
		}
	},
	// åˆ·æ–°tokené…ç½®
	refreshToken: {
		// åˆ¤æ–­tokenæ˜¯å¦è¿‡æœŸ
		isExpired: (method, error) => {
			// å¦‚æœæ˜¯ç™½åå•æ¥å£ä¸åˆ¤æ–­è¿‡æœŸ
			if (method.meta?.noAuth) {
				return false
			}

			// æ£€æŸ¥æ˜¯å¦æ˜¯401é”™è¯¯
			if (error?.status === 401) {
				return true
			}

			const refreshToken = TokenService.getRefreshToken()
			// æ£€æŸ¥refresh tokenæ˜¯å¦å­˜åœ¨
			if (!refreshToken) {
				TokenService.clearTokens()
				window.location.href = '/login'
				return false
			}

			// æ£€æŸ¥access tokenæ˜¯å¦å­˜åœ¨
			const accessToken = TokenService.getToken()
			if (!accessToken) {
				return true
			}

			return false
		},

		// åˆ·æ–°tokençš„å¤„ç†å‡½æ•°
		handler: async () => {
			try {
				const response = await refreshTokenRequest().send()

				const responseData = await response.json()
				if (!response.ok || !responseData?.data) {
					throw new Error('Tokenåˆ·æ–°å¤±è´¥')
				}
				const { token_type, access_token, refresh_token, expires_in } = responseData
				if (!access_token || !refresh_token) {
					throw new Error('æ— æ•ˆä»¤tokenåˆ·æ–°å“åº”')
				}
				// æ›´æ–°token
				TokenService.setTokens(token_type ? token_type + ' ' + access_token : access_token, refresh_token, expires_in * 1000)
				window.location.reload()
				return responseData
			} catch (err) {
				ElNotification({
					title: 'ç™»å½•å¤±è´¥',
					message: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
					type: 'error',
				})
				console.error('Tokenåˆ·æ–°å¤±è´¥:', err)
				// åˆ·æ–°å¤±è´¥,æ¸…é™¤tokenå¹¶è·³è½¬åˆ°ç™»å½•é¡µ
				TokenService.clearTokens()
				window.location.href = '/login'
				throw err
			}
		},
	},
})
```




