---
title: è¡¨æ ¼æ•°æ®å¯¼å‡ºåŠŸèƒ½å®ç°åŸç†
---

# Vue3åå°ç®¡ç†ç³»ç»Ÿï¼ˆå…­ï¼‰ï¼šè¡¨æ ¼æ•°æ®å¯¼å‡ºåŠŸèƒ½å®ç°åŸç†


## å¯¼å‡ºåŠŸèƒ½ç‰¹ç‚¹

1. **çµæ´»çš„é…ç½®é€‰é¡¹**ï¼šæ”¯æŒè®¾ç½®æ–‡ä»¶åã€æ ‡é¢˜ã€å‰¯æ ‡é¢˜ã€åˆ—å®½ã€æ’é™¤ç‰¹å®šåˆ—ç­‰
2. **æ•°æ®æ ¼å¼å¤„ç†**ï¼šè‡ªåŠ¨è¯†åˆ«å’Œå¤„ç†æ•°å­—æ ¼å¼ï¼Œä¿æŒä¸åŸè¡¨æ ¼ä¸€è‡´
3. **æ ·å¼æ”¯æŒ**ï¼šæ”¯æŒè¡¨å¤´æ ·å¼ã€å•å…ƒæ ¼è¾¹æ¡†ã€å¯¹é½æ–¹å¼ç­‰æ ·å¼è®¾ç½®
4. **å›¾ç‰‡å¯¼å‡º**ï¼šæ”¯æŒå¯¼å‡ºè¡¨æ ¼ä¸­çš„å›¾ç‰‡åˆ°Excelä¸­
5. **å¤šçº§è¡¨å¤´æ”¯æŒ**ï¼šå¯ä»¥å¤„ç†å¤æ‚çš„å¤šçº§åµŒå¥—è¡¨å¤´ç»“æ„
6. **è‡ªé€‚åº”åˆ—å®½**ï¼šåŸºäºå†…å®¹è‡ªåŠ¨è®¡ç®—æœ€ä½³åˆ—å®½ï¼Œè€ƒè™‘ä¸­è‹±æ–‡å­—ç¬¦å®½åº¦å·®å¼‚
7. **ç”¨æˆ·å‹å¥½çš„äº¤äº’**ï¼šå¯¼å‡ºè¿‡ç¨‹ä¸­æ˜¾ç¤ºåŠ è½½æç¤ºï¼Œå‡ºé”™æ—¶æä¾›é”™è¯¯ä¿¡æ¯

## æŠ€æœ¯å®ç°å…³é”®ç‚¹

1. **DOMæ“ä½œ**ï¼šé€šè¿‡DOMé€‰æ‹©å™¨è·å–è¡¨æ ¼ç»“æ„å’Œæ•°æ®
2. **ExcelJSåº“**ï¼šåˆ©ç”¨ExcelJSåº“åˆ›å»ºå’Œæ ¼å¼åŒ–Excelæ–‡ä»¶
3. **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨async/awaitå¤„ç†å¼‚æ­¥æ“ä½œï¼Œå¦‚å›¾ç‰‡åŠ è½½
4. **é€’å½’ç®—æ³•**ï¼šé€šè¿‡é€’å½’æ–¹å¼å¤„ç†å¤šçº§è¡¨å¤´ç»“æ„
5. **æ•°æ®è½¬æ¢**ï¼šå°†DOMè¡¨æ ¼æ•°æ®è½¬æ¢ä¸ºé€‚åˆExcelå¯¼å‡ºçš„æ ¼å¼
6. **å•å…ƒæ ¼åˆå¹¶**ï¼šå¤„ç†å¤šçº§è¡¨å¤´ä¸­çš„å•å…ƒæ ¼åˆå¹¶

## ä¸€ã€å¯¼å‡ºåŠŸèƒ½æ ¸å¿ƒå®ç°

å¯¼å‡ºåŠŸèƒ½ä¸»è¦é€šè¿‡`src/utils/exportTable.js`æ–‡ä»¶ä¸­çš„å·¥å…·å‡½æ•°å®ç°ï¼Œæ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š

```javascript
/**
 * @description è¡¨æ ¼å¯¼å‡ºï¼Œæ”¯æŒæ ·å¼ã€å›¾ç‰‡ã€æ•°å­—æ ¼å¼ç­‰
 * @Author Wangkaibing
 * @Date 2025-04-29
 */
import ExcelJS from 'exceljs' // ä½¿ç”¨ExcelJSåº“å¤„ç†Excelæ–‡ä»¶
import { saveAs } from 'file-saver' // ä½¿ç”¨file-saveråº“ä¿å­˜æ–‡ä»¶
import { ElLoading, ElMessage } from 'element-plus' // ä½¿ç”¨Element Plusçš„UIç»„ä»¶
```

### 1. ä¸»è¦å¯¼å‡ºå…¥å£å‡½æ•°

```javascript
/**
 * @description å¯¼å‡ºExcel
 * @param {string} filename å¯¼å‡ºæ–‡ä»¶å
 * @param {Object} tableRef BaseTableç»„ä»¶çš„ref
 * @param {Object|Array} numberColumns æ•°å­—åˆ—é…ç½®æˆ–è¡¨å¤´é…ç½®æ•°ç»„
 * @param {string} title ä¸»æ ‡é¢˜
 * @param {string} subTitle å‰¯æ ‡é¢˜
 * @param {Object} columnWidth åˆ—å®½é…ç½® { min: æœ€å°å®½åº¦, max: æœ€å¤§å®½åº¦, padding: å†…è¾¹è· }
 * @param {Array} excludeLabels éœ€è¦æ’é™¤çš„åˆ—æ ‡é¢˜
 */
export const exportBaseTable = async (
    filename,
    tableRef,
    numberColumns = { labels: [], format: '0.00' },
    title = '',
    subTitle = '',
    columnWidth = { min: 8, max: 40, padding: 4 },
    excludeLabels = ['æ“ä½œ'],
) => {
    // è·å–è¡¨æ ¼DOMå…ƒç´ 
    const table = tableRef.value?.$el?.querySelector('.el-table')
    if (!table) {
        ElMessage.error('æ‰¾ä¸åˆ°è¡¨æ ¼å…ƒç´ ')
        return
    }
    
    // ç¡®ä¿numberColumnsæ ¼å¼æ­£ç¡®
    let formattedNumberColumns = numberColumns
    if (!Array.isArray(numberColumns) && (!numberColumns || !numberColumns.labels)) {
        formattedNumberColumns = { labels: [], format: '0.00' }
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºå¤šçº§è¡¨å¤´
    const isMultiLevel = Array.isArray(formattedNumberColumns) && formattedNumberColumns.some((col) => col.children)
    
    try {
        // è°ƒç”¨å†…éƒ¨å¯¼å‡ºå‡½æ•°
        await exportTableToExcel({
            filename,
            table,
            autoWidth: true,
            numberColumns: formattedNumberColumns,
            columnWidth,
            excludeLabels,
            isMultiLevel,
            title,
            subTitle,
        })
    } catch (error) {
        ElMessage.error(`å¯¼å‡ºå¤±è´¥ï¼š${error.message || error}`)
    }
}
```

### 2. æ ¸å¿ƒå¯¼å‡ºå¤„ç†å‡½æ•°

å®é™…çš„å¯¼å‡ºå¤„ç†ç”±`exportTableToExcel`å‡½æ•°å®Œæˆï¼š

```javascript
export const exportTableToExcel = async (options) => {
    // æ˜¾ç¤ºåŠ è½½é®ç½©å±‚
    const loadingInstance = ElLoading.service({
        lock: true,
        text: 'æ­£åœ¨å¯¼å‡ºExcel...',
        background: 'rgba(0, 0, 0, 0.7)',
    })
    
    try {
        const {
            filename = 'å¯¼å‡ºæ–‡ä»¶',
            table,
            autoWidth = true,
            beforeExport,
            excludeLabels = ['æ“ä½œ'],
            columnWidth = { min: 8, max: 40, padding: 4 },
            numberColumns = { labels: [], format: '0' },
            isMultiLevel = false,
            title = '',
            subTitle = '',
        } = options
        
        // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
        const workbook = new ExcelJS.Workbook()
        const worksheet = workbook.addWorksheet('Sheet1')
        
        // æ ¹æ®è¡¨å¤´ç±»å‹é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
        if (isMultiLevel && Array.isArray(numberColumns)) {
            // å¤„ç†å¤šçº§è¡¨å¤´çš„æƒ…å†µ
            await exportMultiLevelTable({
                workbook,
                worksheet,
                table,
                columns: numberColumns,
                autoWidth,
                columnWidth,
                excludeLabels,
                title,
                subTitle,
            })
        } else {
            // å¤„ç†æ™®é€šè¡¨å¤´çš„æƒ…å†µ
            
            // è·å–è¡¨å¤´å•å…ƒæ ¼ï¼Œæ’é™¤éšè—åˆ—å’Œgutteråˆ—
            const headerCells = Array.from(table.querySelectorAll('.el-table__header-wrapper th:not(.is-hidden):not(.gutter)'))
            
            // è®¡ç®—è¦å¯¼å‡ºçš„åˆ—ç´¢å¼•ï¼Œæ’é™¤æŒ‡å®šæ ‡ç­¾çš„åˆ—
            const exportColumnIndexes = headerCells
                .map((th, index) => (!excludeLabels.includes(th.textContent.trim()) ? index : -1))
                .filter((index) => index !== -1)
                
            // è¿‡æ»¤å¹¶è·å–è¡¨å¤´æ–‡æœ¬
            const headers = headerCells
                .filter((th) => !excludeLabels.includes(th.textContent.trim()))
                .map((th) => th.textContent.trim())
                
            // è·å–æ•°å­—åˆ—é…ç½®
            const numberLabels = Array.isArray(numberColumns) ? [] : numberColumns.labels || []
            const numberFormat = Array.isArray(numberColumns) ? '0.00' : numberColumns.format || '0.00'
            const numberColumnIndexes = headers
                .map((header, index) => (numberLabels.includes(header) ? index : -1))
                .filter((index) => index !== -1)
                
            // è·å–è¡¨æ ¼æ•°æ®
            const rows = table.querySelectorAll('.el-table__body-wrapper tbody tr:not(.el-table__row--hidden)')
            const data = Array.from(rows).map((row) => {
                const cells = Array.from(row.querySelectorAll('td:not(.is-hidden):not(.gutter)'))
                return exportColumnIndexes.map((index) => {
                    const td = cells[index]
                    const text = td.textContent.trim()
                    const filteredIndex = exportColumnIndexes.indexOf(index)
                    
                    // å¤„ç†æ•°å€¼æ ¼å¼
                    const { value, isNumber, numFormat } = processNumericValue(text)
                    
                    return {
                        value,
                        isNumber,
                        numFormat: numberColumnIndexes.includes(filteredIndex) ? numberFormat || numFormat : numFormat,
                        tagType: td.querySelector('.el-tag')?.getAttribute('type') || null,
                        imgSrc: getImageUrl(td), // å¤„ç†å•å…ƒæ ¼ä¸­çš„å›¾ç‰‡
                    }
                })
            })
            
            // è®¾ç½®åˆ—å®½å’Œæ ¼å¼
            worksheet.columns = headers.map((header, index) => {
                // è®¡ç®—æœ€å¤§å®½åº¦ï¼ˆè€ƒè™‘è¡¨å¤´å’Œå†…å®¹ï¼‰
                const maxWidth = Math.min(
                    Math.max(
                        getStringWidth(header),
                        ...data.map((row) => getStringWidth(String(row[index].value))),
                        columnWidth.min
                    ) + columnWidth.padding,
                    columnWidth.max
                )
                
                return {
                    header,
                    key: String(index),
                    width: autoWidth ? maxWidth : 15,
                }
            })
            
            // æ·»åŠ æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
            const titleRows = addTitleRows(worksheet, title, subTitle, headers.length)
            
            // è®¾ç½®è¡¨å¤´æ ·å¼
            const headerRow = worksheet.getRow(titleRows + 1)
            headerRow.height = 25
            headerRow.eachCell((cell) => setCellStyle(cell, true))
            
            // æ·»åŠ æ•°æ®å’Œæ ·å¼
            for (let rowIndex = 0; rowIndex < data.length; rowIndex++) {
                const rowData = data[rowIndex]
                const row = worksheet.addRow([])
                row.height = 30
                row.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true }
                
                // å¤„ç†æ¯ä¸ªå•å…ƒæ ¼
                for (let colIndex = 0; colIndex < rowData.length; colIndex++) {
                    const cellData = rowData[colIndex]
                    const cell = row.getCell(colIndex + 1)
                    
                    // è®¾ç½®å•å…ƒæ ¼å€¼å’Œæ ·å¼
                    cell.value = cellData.value
                    setCellStyle(cell)
                    
                    // ä¸ºæ•°å­—å•å…ƒæ ¼è®¾ç½®æ ¼å¼
                    if (cellData.isNumber) {
                        cell.numFmt = cellData.numFormat
                    }
                    
                    // å¤„ç†å›¾ç‰‡
                    if (cellData.imgSrc) {
                        const imageBuffer = await getImageBuffer(cellData.imgSrc)
                        if (imageBuffer) {
                            const imageId = workbook.addImage({
                                buffer: imageBuffer,
                                extension: 'png',
                            })
                            // æ·»åŠ å›¾ç‰‡åˆ°å•å…ƒæ ¼
                            worksheet.addImage(imageId, {
                                tl: { col: colIndex, row: rowIndex + 1 + titleRows },
                                ext: { width: 35, height: 35 },
                                editAs: 'oneCell',
                            })
                        }
                    }
                }
            }
        }
        
        // æ‰§è¡Œå¯¼å‡ºå‰çš„å›è°ƒå‡½æ•°
        if (beforeExport) {
            await beforeExport(worksheet)
        }
        
        // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
        const blob = new Blob([await workbook.xlsx.writeBuffer()])
        saveAs(blob, `${filename}.xlsx`)
    } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error)
        ElMessage.error(`å¯¼å‡ºå¤±è´¥ï¼š${error.message || error}`)
        throw error
    } finally {
        loadingInstance.close() // å…³é—­åŠ è½½é®ç½©
    }
}
```

## äºŒã€ä¸»è¦è¾…åŠ©å‡½æ•°

### 1. æ–‡æœ¬å®½åº¦è®¡ç®—

```javascript
/**
 * @description è®¡ç®—å­—ç¬¦ä¸²æ˜¾ç¤ºå®½åº¦ï¼ˆä¸­æ–‡2ä¸ªå•ä½ï¼Œå…¶ä»–1ä¸ªå•ä½ï¼‰
 * @param {string} str è¦è®¡ç®—çš„å­—ç¬¦ä¸²
 * @returns {number} å­—ç¬¦ä¸²çš„æ˜¾ç¤ºå®½åº¦
 */
const getStringWidth = (str) => {
    // ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦å’Œreduceè®¡ç®—å®½åº¦ï¼Œä¸­æ–‡å­—ç¬¦å 2ä¸ªå•ä½ï¼Œå…¶ä»–å­—ç¬¦å 1ä¸ªå•ä½
    return [...str].reduce(
        (width, char) => width + (char.charCodeAt(0) > 127 || char.charCodeAt(0) === 94 ? 2 : 1),
        0
    )
}
```

### 2. å›¾ç‰‡å¤„ç†

```javascript
/**
 * @description ä»URLè·å–å›¾ç‰‡çš„Bufferæ•°æ®
 * @param {string} url å›¾ç‰‡URL
 * @returns {Promise<Buffer>} å›¾ç‰‡buffer
 */
const getImageBuffer = async (url) => {
    try {
        // é€šè¿‡fetchè·å–å›¾ç‰‡å¹¶è½¬æ¢ä¸ºArrayBuffer
        return await (await fetch(url)).blob().then((blob) => blob.arrayBuffer())
    } catch (error) {
        console.log('ğŸš€ ~ [è·å–å›¾ç‰‡å¤±è´¥]', error)
        return null
    }
}

/**
 * @description è·å–DOMå…ƒç´ ä¸­çš„å›¾ç‰‡URLï¼Œæ”¯æŒimgã€imageã€el-imageç­‰æ ‡ç­¾
 * @param {HTMLElement} element DOMå…ƒç´ 
 * @returns {string|null} å›¾ç‰‡URL
 */
const getImageUrl = (element) => {
    // æ£€æŸ¥imgæ ‡ç­¾
    const img = element.querySelector('img')
    if (img?.src) return img.src
    
    // æ£€æŸ¥imageæ ‡ç­¾
    const image = element.querySelector('image')
    if (image?.href?.baseVal) return image.href.baseVal
    
    // æ£€æŸ¥el-imageç»„ä»¶
    const elImageImg = element.querySelector('.el-image img')
    if (elImageImg?.src) return elImageImg.src
    
    return null
}
```

### 3. æ•°å­—å€¼å¤„ç†

```javascript
/**
 * @description å¤„ç†å•å…ƒæ ¼ä¸­çš„æ•°å­—å€¼ï¼Œè¯†åˆ«æ ¼å¼
 * @param {string} text å•å…ƒæ ¼æ–‡æœ¬
 * @returns {Object} å¤„ç†åçš„æ•°å­—ä¿¡æ¯
 */
const processNumericValue = (text) => {
    // ç§»é™¤åƒåˆ†ä½åˆ†éš”ç¬¦
    const cleanText = text.replace(/,/g, '')
    let isNumber = false
    let value = text
    let numFormat = '0'
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—
    if (!isNaN(parseFloat(cleanText)) && isFinite(cleanText)) {
        isNumber = true
        value = parseFloat(cleanText)
        
        // åˆ¤æ–­æ•°å­—ç±»å‹å¹¶è®¾ç½®åˆé€‚çš„æ ¼å¼
        if (cleanText.includes('.')) {
            // è·å–å°æ•°ä½æ•°å¹¶ä¿ç•™åŸå§‹æ ¼å¼
            const decimalPlaces = cleanText.split('.')[1]?.length || 0
            numFormat = decimalPlaces > 0 ? `0.${'0'.repeat(decimalPlaces)}` : '0'
        }
    }
    
    return { value, isNumber, numFormat }
}
```

### 4. å•å…ƒæ ¼æ ·å¼è®¾ç½®

```javascript
/**
 * @description è®¾ç½®å•å…ƒæ ¼æ ·å¼
 * @param {Object} cell Excelå•å…ƒæ ¼å¯¹è±¡
 * @param {boolean} isHeader æ˜¯å¦ä¸ºè¡¨å¤´å•å…ƒæ ¼
 */
const setCellStyle = (cell, isHeader = false) => {
    // è®¾ç½®å­—ä½“
    cell.font = { size: isHeader ? 13 : 11, bold: isHeader }
    
    // è®¾ç½®å¯¹é½æ–¹å¼
    cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true }
    
    // è®¾ç½®è¾¹æ¡†
    cell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' },
    }
    
    // ä¸ºè¡¨å¤´è®¾ç½®èƒŒæ™¯è‰²
    if (isHeader) {
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFf0f2f5' }, // æµ…ç°è‰²èƒŒæ™¯
        }
    }
}
```

### 5. æ ‡é¢˜è¡Œå¤„ç†

```javascript
/**
 * @description æ·»åŠ æ ‡é¢˜å’Œå‰¯æ ‡é¢˜è¡Œ
 * @param {Object} worksheet Excelå·¥ä½œè¡¨
 * @param {string} title ä¸»æ ‡é¢˜
 * @param {string} subTitle å‰¯æ ‡é¢˜
 * @param {number} columnsCount åˆ—æ•°
 * @returns {number} æ·»åŠ çš„æ ‡é¢˜è¡Œæ•°
 */
const addTitleRows = (worksheet, title, subTitle, columnsCount) => {
    let titleRows = 0
    
    // è®¡ç®—éœ€è¦æ’å…¥çš„æ ‡é¢˜è¡Œæ•°
    if (title) titleRows++
    if (subTitle) titleRows++
    
    if (titleRows > 0) {
        // æ·»åŠ ç©ºè¡Œç”¨äºæ ‡é¢˜
        worksheet.spliceRows(1, 0, ...Array(titleRows).fill([]))
        
        // æ·»åŠ ä¸»æ ‡é¢˜
        if (title) {
            const titleRow = worksheet.getRow(1)
            const firstCell = titleRow.getCell(1)
            firstCell.value = title
            firstCell.font = { size: 16, bold: true }
            firstCell.alignment = { vertical: 'middle', horizontal: 'center' }
            
            // åˆå¹¶æ ‡é¢˜å•å…ƒæ ¼
            if (columnsCount > 1) {
                worksheet.mergeCells(1, 1, 1, columnsCount)
            }
            
            titleRow.height = 30
        }
        
        // æ·»åŠ å‰¯æ ‡é¢˜
        if (subTitle) {
            const subTitleRowIndex = title ? 2 : 1
            const subTitleRow = worksheet.getRow(subTitleRowIndex)
            const firstCell = subTitleRow.getCell(1)
            firstCell.value = subTitle
            firstCell.font = { size: 14, bold: true }
            firstCell.alignment = { vertical: 'middle', horizontal: 'center' }
            
            // åˆå¹¶å‰¯æ ‡é¢˜å•å…ƒæ ¼
            if (columnsCount > 1) {
                worksheet.mergeCells(subTitleRowIndex, 1, subTitleRowIndex, columnsCount)
            }
            
            subTitleRow.height = 25
        }
    }
    
    return titleRows
}
```

## ä¸‰ã€å¤šçº§è¡¨å¤´å¤„ç†

æ”¯æŒå¯¼å‡ºå¤šçº§è¡¨å¤´è¡¨æ ¼ï¼š

### 1. å¤šçº§è¡¨å¤´æ‰å¹³åŒ–å¤„ç†

```javascript
/**
 * @description æ‰å¹³åŒ–å¤šçº§è¡¨å¤´é…ç½®
 * @param {Array} columns è¡¨å¤´é…ç½®æ•°ç»„
 * @returns {Array} æ‰å¹³åŒ–çš„è¡¨å¤´é…ç½®
 */
const flattenColumns = (columns) => {
    const result = []
    
    // é€’å½’éå†è¡¨å¤´é…ç½®
    const traverse = (items, parentHeaders = []) => {
        items.forEach((item) => {
            if (item.children && item.children.length > 0) {
                // å¦‚æœæœ‰å­åˆ—ï¼Œåˆ™é€’å½’å¤„ç†
                const currentPath = [...parentHeaders, item.label]
                traverse(item.children, currentPath)
            } else {
                // å¶å­èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°ç»“æœä¸­
                const parentPath = parentHeaders.join(' - ')
                result.push({
                    ...item,
                    fullLabel: parentHeaders.length > 0 ? parentHeaders.join(' - ') + ' - ' + item.label : item.label,
                    parentLabel: parentPath || '',
                    parentHeaders: parentHeaders, // ä¿å­˜å®Œæ•´çš„çˆ¶çº§è·¯å¾„æ•°ç»„
                })
            }
        })
    }

    traverse(columns)
    return result
}
```

### 2. å¤šçº§è¡¨å¤´å¯¼å‡ºå¤„ç†

```javascript
/**
 * @description å¯¼å‡ºå¤šçº§è¡¨å¤´è¡¨æ ¼
 * @param {Object} options é…ç½®é¡¹
 */
async function exportMultiLevelTable(options) {
    const { 
        workbook, 
        worksheet, 
        table, 
        columns, 
        autoWidth = true, 
        columnWidth = { min: 8, max: 40, padding: 4 }, 
        excludeLabels = ['æ“ä½œ'], 
        title = '', 
        subTitle = '' 
    } = options
    
    // æ‰å¹³åŒ–å¤šçº§è¡¨å¤´ï¼Œæ’é™¤ä¸éœ€è¦çš„åˆ—
    const flattenedColumns = flattenColumns(columns).filter((col) => !excludeLabels.includes(col.label))
    
    // è·å–æœ€å¤§åµŒå¥—å±‚çº§æ•°
    const maxLevel = Math.max(...flattenedColumns.map((col) => (col.parentHeaders ? col.parentHeaders.length + 1 : 1)))
    
    // æå–è¡¨å¤´æ–‡æœ¬
    const headers = flattenedColumns.map((col) => col.label)
    
    // ä»DOMè·å–è¡¨æ ¼æ•°æ®
    const rows = table.querySelectorAll('.el-table__body-wrapper tbody tr:not(.el-table__row--hidden)')
    const data = Array.from(rows)
        .map((row) => {
            // è·å–å•å…ƒæ ¼å¹¶å¤„ç†æ•°æ®
            return Array.from(row.querySelectorAll('td:not(.is-hidden):not(.gutter)')).map((cell) => {
                const cellText = cell.textContent.trim()
                return processNumericValue(cellText)
            })
        })
        .filter((rowData) => rowData.length > 0)
    
    // è®¾ç½®åˆ—å®½
    worksheet.columns = headers.map((header, index) => {
        // è®¡ç®—æœ€å¤§å®½åº¦
        const cellValues = data
            .filter((row) => index < row.length)
            .map((row) => String(row[index]?.value || ''))
        const maxWidth = Math.min(
            Math.max(getStringWidth(header), ...cellValues.map(getStringWidth), columnWidth.min) + columnWidth.padding,
            columnWidth.max
        )
        
        return {
            key: String(index),
            width: autoWidth ? maxWidth : 15,
        }
    })
    
    // æ·»åŠ æ ‡é¢˜è¡Œå¹¶è·å–æ ‡é¢˜è¡Œæ•°
    const titleRows = addTitleRows(worksheet, title, subTitle, headers.length)
    
    // å¤„ç†å¤šçº§è¡¨å¤´
    if (maxLevel > 1) {
        // ä¸ºæ¯ä¸ªçº§åˆ«çš„è¡¨å¤´åˆ›å»ºè¡Œ
        for (let level = 0; level < maxLevel; level++) {
            worksheet.spliceRows(titleRows + level + 1, 0, [])
            const headerRow = worksheet.getRow(titleRows + level + 1)
            headerRow.height = 25
        }
        
        // å¤„ç†æ¯ä¸€åˆ—çš„è¡¨å¤´
        let colIndex = 1
        const headerGroups = {}
        
        // é¦–å…ˆæ„å»ºæ¯ä¸ªçº§åˆ«çš„è¡¨å¤´ç»„
        flattenedColumns.forEach((col) => {
            // éå†æ¯ä¸ªçº§åˆ«
            for (let level = 0; level < maxLevel; level++) {
                const key = `level_${level}`
                if (!headerGroups[key]) {
                    headerGroups[key] = []
                }
                
                // è·å–å½“å‰çº§åˆ«çš„æ ‡ç­¾
                let label = null
                if (level < col.parentHeaders.length) {
                    // çˆ¶çº§è¡¨å¤´
                    label = col.parentHeaders[level]
                } else if (level === col.parentHeaders.length) {
                    // å¶å­èŠ‚ç‚¹è‡ªèº«
                    label = col.label
                }
                
                if (label) {
                    // è®°å½•è¿™ä¸ªæ ‡ç­¾åŠå…¶æ‰€åœ¨çš„åˆ—ä½ç½®
                    headerGroups[key].push({
                        label,
                        colIndex: colIndex,
                        isLeaf: level === col.parentHeaders.length,
                    })
                }
            }
            colIndex++
        })
        
        // åˆå¹¶ç›¸åŒçš„è¡¨å¤´å•å…ƒæ ¼
        Object.keys(headerGroups).forEach((levelKey) => {
            const level = parseInt(levelKey.split('_')[1])
            const headerRow = worksheet.getRow(titleRows + level + 1)
            
            // æŸ¥æ‰¾ç›¸é‚»çš„ç›¸åŒæ ‡ç­¾å¹¶åˆå¹¶
            let startCol = -1
            let currentLabel = null
            let count = 0
            
            // æ·»åŠ ä¸€ä¸ªç»“æŸæ ‡è®°ï¼Œè®©æœ€åä¸€ç»„ä¹Ÿèƒ½è¢«å¤„ç†
            const headers = [...headerGroups[levelKey], { label: null, colIndex: -1 }]
            headers.forEach((header, idx) => {
                if (header.label !== currentLabel || idx === headers.length - 1) {
                    // å¤„ç†å‰ä¸€ç»„
                    if (currentLabel !== null && count > 1) {
                        // åˆå¹¶å•å…ƒæ ¼
                        worksheet.mergeCells(
                            titleRows + level + 1,
                            startCol,
                            titleRows + level + 1,
                            startCol + count - 1
                        )
                    }
                    
                    if (header.label !== null) {
                        // å¼€å§‹ä¸€ä¸ªæ–°ç»„
                        startCol = header.colIndex
                        currentLabel = header.label
                        count = 1
                        
                        // è®¾ç½®å•å…ƒæ ¼å€¼
                        const cell = headerRow.getCell(startCol)
                        cell.value = currentLabel
                        setCellStyle(cell, true)
                    }
                } else {
                    // ç»§ç»­å½“å‰ç»„
                    count++
                }
            })
        })
        
        // å¤„ç†è·¨è¡Œçš„å•å…ƒæ ¼
        flattenedColumns.forEach((col, idx) => {
            const leafLevel = col.parentHeaders.length
            const leafCell = worksheet.getRow(titleRows + leafLevel + 1).getCell(idx + 1)
            
            // å¦‚æœå¶å­èŠ‚ç‚¹ä¸‹æ²¡æœ‰å…¶ä»–è¡Œï¼Œåˆ™å‘ä¸‹åˆå¹¶å•å…ƒæ ¼
            if (leafLevel < maxLevel - 1) {
                worksheet.mergeCells(
                    titleRows + leafLevel + 1,
                    idx + 1,
                    titleRows + maxLevel,
                    idx + 1
                )
                
                // è®¾ç½®åˆå¹¶åå•å…ƒæ ¼çš„å€¼
                leafCell.value = col.label
                setCellStyle(leafCell, true)
            }
        })
    } else {
        // å•è¡Œè¡¨å¤´çš„ç®€å•å¤„ç†
        const headerRow = worksheet.getRow(titleRows + 1)
        headerRow.height = 25
        headerRow.eachCell((cell) => setCellStyle(cell, true))
    }
    
    // å¤„ç†æ•°æ®è¡Œ
    data.forEach((rowData, rowIndex) => {
        // åˆ›å»ºè¡Œå¹¶æ·»åŠ å€¼
        const values = rowData.map((cell) => cell.value)
        const excelRow = worksheet.addRow(values)
        excelRow.height = 30
        excelRow.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true }
        
        // è®¾ç½®å•å…ƒæ ¼æ ·å¼å’Œæ ¼å¼
        rowData.forEach((cellData, colIndex) => {
            const cell = excelRow.getCell(colIndex + 1)
            setCellStyle(cell)
            
            // ä¸ºæ•°å­—å•å…ƒæ ¼è®¾ç½®ä¸åŸå§‹æ ¼å¼åŒ¹é…çš„æ•°å­—æ ¼å¼
            if (cellData.isNumber) {
                cell.numFmt = cellData.numFormat
            }
        })
    })
}
```

## å››ã€å®é™…åº”ç”¨ç¤ºä¾‹

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä»¥ç”¨æˆ·ç®¡ç†é¡µé¢ä¸ºä¾‹ï¼Œå¯¼å‡ºåŠŸèƒ½çš„ä½¿ç”¨éå¸¸ç®€æ´ï¼š

```javascript
// å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
import { exportBaseTable } from '@/utils/exportTable'

// å®šä¹‰è¡¨æ ¼åˆ—é…ç½®
const columns = [
    { prop: 'id', label: 'ç”¨æˆ·ID', width: '100' },
    { prop: 'organizations', label: 'å…³è”åŒºåˆ’', width: '200' },
    { prop: 'fullname', label: 'ç”¨æˆ·å§“å', width: '200', tip: true },
    // å…¶ä»–åˆ—å®šä¹‰...
]

// åœ¨å¯¼å‡ºæŒ‰é’®ç‚¹å‡»æ—¶è°ƒç”¨
const handleAction = ({ type }) => {
    switch (type) {
        case 'export':
            // è°ƒç”¨å¯¼å‡ºå‡½æ•°ï¼Œä¼ å…¥æ–‡ä»¶åã€è¡¨æ ¼å¼•ç”¨ã€åˆ—é…ç½®å’Œæ ‡é¢˜
            exportBaseTable('ç”¨æˆ·åˆ—è¡¨', tableRef, columns, 'ç”¨æˆ·åˆ—è¡¨')
            break
        // å…¶ä»–æ“ä½œ...
    }
}
```
